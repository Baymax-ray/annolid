
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Annolid on Detectron2 Tutorial &#8212; Annolid Documentation</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/cpl_logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Annolid Documentation</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../content/README.html">
   Annolid Documentation
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Getting Started
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../content/introduction.html">
   Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../content/high_level_overview.html">
   High level overview
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../content/how_to_install.html">
   How to install
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../content/docker_container.html">
   Docker
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../content/gui_or_cli.html">
   GUI or CLI ?
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../content/extract_frames.html">
   Extract frames
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../content/labelling_images.html">
   How to label images
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../content/save_labels.html">
   Save Labels
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../content/create_coco.html">
   Create your COCO format dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../content/tips_and_tricks.html">
   Tips and tricks
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Annolid Zoo
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../content/annolid_zoo.html">
   Annolid ModelZoo
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Community
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../content/contributing.html">
   New contributor guide
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../content/get_in_touch.html">
   Get in touch
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../content/licence.html">
   Licence
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../content/cite_annolid.html">
   Cite Annolid
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../content/work_based_on_annolid.html">
   Work based on annolid
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/tutorials/Annolid_on_Detectron2_Tutorial_Example_Dataset.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/jeremyforest/annolid/"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/jeremyforest/annolid//issues/new?title=Issue%20on%20page%20%2Ftutorials/Annolid_on_Detectron2_Tutorial_Example_Dataset.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/jeremyforest/annolid/master?urlpath=tree/book/tutorials/Annolid_on_Detectron2_Tutorial_Example_Dataset.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Annolid on Detectron2 Tutorial
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#install-detectron2">
   Install detectron2
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#upload-a-labeled-dataset">
     Upload a labeled dataset.
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#run-a-pre-trained-detectron2-model">
   Run a pre-trained detectron2 model
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#train-on-a-custom-dataset">
   Train on a custom dataset
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#prepare-the-dataset">
     Prepare the dataset
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#train">
     Train!
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#inference-evaluation-using-the-trained-model">
     Inference &amp; evaluation using the trained model
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#todo-expand-on-how-to-interpret-ap">
       #TODO: expand on  how to interpret AP
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#let-s-test-our-newly-trained-mode-on-a-new-video">
   Let’s test our newly trained mode on a new video
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#we-download-a-video-from-a-url">
     We download a video from a URL
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#please-change-the-video-input-to-the-path-of-your-inference-video">
       Please change the VIDEO_INPUT to the path of your inference video
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#all-the-tracking-results-will-be-saved-to-this-pandas-dataframe">
     All the tracking results will be saved to this Pandas dataframe.
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#calculate-the-bbox-center-point-x-y-locations">
     Calculate the bbox center point x, y locations
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#only-save-the-top-1-prediction-for-each-frame-for-each-class">
     Only save the top 1 prediction for each frame for each class
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#visualize-the-center-points-with-plotly-scatter-plot">
     Visualize the center points with plotly scatter plot
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#download-the-tracking-result-csv-file-to-your-local-device">
     Download the tracking result CSV file to your local device
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-following-sections-are-optional">
   The following sections are optional.
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#caculate-the-distance-of-a-pair-of-instances-in-a-given-frame">
     Caculate the distance of a pair of instances in a given frame
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#calculate-the-distance-of-the-instance-from-the-current-and-previous-frame">
     Calculate the distance of the instance from the current and previous frame
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-total-distance-traveled-for-frog-male-in-tank-1-in-pixels">
     The total distance traveled for frog male in Tank 1 in pixels
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#download-and-save-the-results-to-your-local-device">
     Download and save the results to your local device
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#please-change-the-desired-csv-file-name">
       Please change the desired CSV file name
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#distance-between-frog-male-in-tank-2-and-frog-female-in-tank-2-in-pixels">
     Distance between frog male in tank 2 and frog female in tank 2 in pixels
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#save-and-download-the-trained-model-weights">
     Save and download the trained model weights
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Annolid on Detectron2 Tutorial</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Annolid on Detectron2 Tutorial
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#install-detectron2">
   Install detectron2
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#upload-a-labeled-dataset">
     Upload a labeled dataset.
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#run-a-pre-trained-detectron2-model">
   Run a pre-trained detectron2 model
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#train-on-a-custom-dataset">
   Train on a custom dataset
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#prepare-the-dataset">
     Prepare the dataset
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#train">
     Train!
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#inference-evaluation-using-the-trained-model">
     Inference &amp; evaluation using the trained model
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#todo-expand-on-how-to-interpret-ap">
       #TODO: expand on  how to interpret AP
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#let-s-test-our-newly-trained-mode-on-a-new-video">
   Let’s test our newly trained mode on a new video
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#we-download-a-video-from-a-url">
     We download a video from a URL
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#please-change-the-video-input-to-the-path-of-your-inference-video">
       Please change the VIDEO_INPUT to the path of your inference video
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#all-the-tracking-results-will-be-saved-to-this-pandas-dataframe">
     All the tracking results will be saved to this Pandas dataframe.
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#calculate-the-bbox-center-point-x-y-locations">
     Calculate the bbox center point x, y locations
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#only-save-the-top-1-prediction-for-each-frame-for-each-class">
     Only save the top 1 prediction for each frame for each class
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#visualize-the-center-points-with-plotly-scatter-plot">
     Visualize the center points with plotly scatter plot
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#download-the-tracking-result-csv-file-to-your-local-device">
     Download the tracking result CSV file to your local device
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-following-sections-are-optional">
   The following sections are optional.
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#caculate-the-distance-of-a-pair-of-instances-in-a-given-frame">
     Caculate the distance of a pair of instances in a given frame
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#calculate-the-distance-of-the-instance-from-the-current-and-previous-frame">
     Calculate the distance of the instance from the current and previous frame
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-total-distance-traveled-for-frog-male-in-tank-1-in-pixels">
     The total distance traveled for frog male in Tank 1 in pixels
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#download-and-save-the-results-to-your-local-device">
     Download and save the results to your local device
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#please-change-the-desired-csv-file-name">
       Please change the desired CSV file name
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#distance-between-frog-male-in-tank-2-and-frog-female-in-tank-2-in-pixels">
     Distance between frog male in tank 2 and frog female in tank 2 in pixels
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#save-and-download-the-trained-model-weights">
     Save and download the trained model weights
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <p><a href="https://colab.research.google.com/github/healthonrails/annolid/blob/main/docs/tutorials/Annolid_on_Detectron2_Tutorial.ipynb" target="_blank"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"/></a></p>
<div class="tex2jax_ignore mathjax_ignore section" id="annolid-on-detectron2-tutorial">
<h1>Annolid on Detectron2 Tutorial<a class="headerlink" href="#annolid-on-detectron2-tutorial" title="Permalink to this headline">¶</a></h1>
<img src="https://dl.fbaipublicfiles.com/detectron2/Detectron2-Logo-Horz.png" width="500">
<p>Welcome to Annolid on detectron2! This is modified from the official colab tutorial of detectron2. Here, we will go through some basics usage of detectron2, including the following:</p>
<ul class="simple">
<li><p>Run inference on images or videos, with an existing detectron2 model</p></li>
<li><p>Train a detectron2 model on a new dataset</p></li>
</ul>
<p>You can make a copy of this tutorial by “File -&gt; Open in playground mode” and play with it yourself. <strong>DO NOT</strong> request access to this tutorial.</p>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="install-detectron2">
<h1>Install detectron2<a class="headerlink" href="#install-detectron2" title="Permalink to this headline">¶</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Is running in colab or in jupyter-notebook</span>
<span class="k">try</span><span class="p">:</span>
  <span class="kn">import</span> <span class="nn">google.colab</span>
  <span class="n">IN_COLAB</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span><span class="p">:</span>
  <span class="n">IN_COLAB</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># install dependencies: </span>
<span class="o">!</span>pip install <span class="nv">pyyaml</span><span class="o">==</span><span class="m">5</span>.3
<span class="kn">import</span> <span class="nn">torch</span><span class="o">,</span> <span class="nn">torchvision</span>
<span class="n">TORCH_VERSION</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">__version__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[:</span><span class="mi">2</span><span class="p">])</span>
<span class="n">CUDA_VERSION</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">__version__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;torch: &quot;</span><span class="p">,</span> <span class="n">TORCH_VERSION</span><span class="p">,</span> <span class="s2">&quot;; cuda: &quot;</span><span class="p">,</span> <span class="n">CUDA_VERSION</span><span class="p">)</span>
<span class="c1"># Install detectron2 that matches the above pytorch version</span>
<span class="c1"># See https://detectron2.readthedocs.io/tutorials/install.html for instructions</span>
<span class="o">!</span>pip install detectron2 -f https://dl.fbaipublicfiles.com/detectron2/wheels/<span class="nv">$CUDA_VERSION</span>/torch<span class="nv">$TORCH_VERSION</span>/index.html
<span class="c1"># If there is not yet a detectron2 release that matches the given torch + CUDA version, you need to install a different pytorch.</span>

<span class="c1"># exit(0)  # After installation, you may need to &quot;restart runtime&quot; in Colab. This line can also restart runtime</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: pyyaml==5.3 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (5.3)
torch:  1.10 ; cuda:  cu102
Looking in links: https://dl.fbaipublicfiles.com/detectron2/wheels/cu102/torch1.10/index.html
Requirement already satisfied: detectron2 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (0.6+cu102)
Requirement already satisfied: termcolor&gt;=1.1 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from detectron2) (1.1.0)
Requirement already satisfied: future in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from detectron2) (0.18.2)
Requirement already satisfied: yacs&gt;=0.1.8 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from detectron2) (0.1.8)
Requirement already satisfied: tensorboard in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from detectron2) (2.7.0)
Requirement already satisfied: hydra-core&gt;=1.1 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from detectron2) (1.1.1)
Requirement already satisfied: pydot in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from detectron2) (1.4.2)
Requirement already satisfied: Pillow&gt;=7.1 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from detectron2) (8.4.0)
Requirement already satisfied: black==21.4b2 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from detectron2) (21.4b2)
Requirement already satisfied: fvcore&lt;0.1.6,&gt;=0.1.5 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from detectron2) (0.1.5.post20211023)
Requirement already satisfied: cloudpickle in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from detectron2) (2.0.0)
Requirement already satisfied: pycocotools&gt;=2.0.2 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from detectron2) (2.0.2)
Requirement already satisfied: matplotlib in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from detectron2) (3.2.2)
Requirement already satisfied: omegaconf&gt;=2.1 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from detectron2) (2.1.1)
Requirement already satisfied: tqdm&gt;4.29.0 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from detectron2) (4.62.3)
Requirement already satisfied: tabulate in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from detectron2) (0.8.9)
Requirement already satisfied: iopath&lt;0.1.10,&gt;=0.1.7 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from detectron2) (0.1.9)
Requirement already satisfied: regex&gt;=2020.1.8 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from black==21.4b2-&gt;detectron2) (2021.11.10)
Requirement already satisfied: typed-ast&gt;=1.4.2 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from black==21.4b2-&gt;detectron2) (1.5.1)
Requirement already satisfied: mypy-extensions&gt;=0.4.3 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from black==21.4b2-&gt;detectron2) (0.4.3)
Requirement already satisfied: appdirs in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from black==21.4b2-&gt;detectron2) (1.4.4)
Requirement already satisfied: click&gt;=7.1.2 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from black==21.4b2-&gt;detectron2) (7.1.2)
Requirement already satisfied: typing-extensions&gt;=3.7.4 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from black==21.4b2-&gt;detectron2) (3.10.0.2)
Requirement already satisfied: pathspec&lt;1,&gt;=0.8.1 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from black==21.4b2-&gt;detectron2) (0.9.0)
Requirement already satisfied: toml&gt;=0.10.1 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from black==21.4b2-&gt;detectron2) (0.10.2)
Requirement already satisfied: pyyaml&gt;=5.1 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from fvcore&lt;0.1.6,&gt;=0.1.5-&gt;detectron2) (5.3)
Requirement already satisfied: numpy in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from fvcore&lt;0.1.6,&gt;=0.1.5-&gt;detectron2) (1.21.3)
Requirement already satisfied: antlr4-python3-runtime==4.8 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from hydra-core&gt;=1.1-&gt;detectron2) (4.8)
Requirement already satisfied: importlib-resources in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from hydra-core&gt;=1.1-&gt;detectron2) (5.4.0)
Requirement already satisfied: portalocker in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from iopath&lt;0.1.10,&gt;=0.1.7-&gt;detectron2) (2.3.2)
Requirement already satisfied: setuptools&gt;=18.0 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from pycocotools&gt;=2.0.2-&gt;detectron2) (58.0.4)
Requirement already satisfied: cython&gt;=0.27.3 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from pycocotools&gt;=2.0.2-&gt;detectron2) (0.29.24)
Requirement already satisfied: pyparsing!=2.0.4,!=2.1.2,!=2.1.6,&gt;=2.0.1 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from matplotlib-&gt;detectron2) (3.0.4)
Requirement already satisfied: kiwisolver&gt;=1.0.1 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from matplotlib-&gt;detectron2) (1.3.2)
Requirement already satisfied: cycler&gt;=0.10 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from matplotlib-&gt;detectron2) (0.10.0)
Requirement already satisfied: python-dateutil&gt;=2.1 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from matplotlib-&gt;detectron2) (2.8.2)
Requirement already satisfied: six in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from cycler&gt;=0.10-&gt;matplotlib-&gt;detectron2) (1.16.0)
Requirement already satisfied: zipp&gt;=3.1.0 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from importlib-resources-&gt;hydra-core&gt;=1.1-&gt;detectron2) (3.7.0)
Requirement already satisfied: requests&lt;3,&gt;=2.21.0 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from tensorboard-&gt;detectron2) (2.26.0)
Requirement already satisfied: tensorboard-data-server&lt;0.7.0,&gt;=0.6.0 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from tensorboard-&gt;detectron2) (0.6.1)
Requirement already satisfied: protobuf&gt;=3.6.0 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from tensorboard-&gt;detectron2) (3.19.0)
Requirement already satisfied: absl-py&gt;=0.4 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from tensorboard-&gt;detectron2) (0.15.0)
Requirement already satisfied: werkzeug&gt;=0.11.15 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from tensorboard-&gt;detectron2) (2.0.2)
Requirement already satisfied: grpcio&gt;=1.24.3 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from tensorboard-&gt;detectron2) (1.41.1)
Requirement already satisfied: google-auth&lt;3,&gt;=1.6.3 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from tensorboard-&gt;detectron2) (2.3.1)
Requirement already satisfied: wheel&gt;=0.26 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from tensorboard-&gt;detectron2) (0.37.0)
Requirement already satisfied: google-auth-oauthlib&lt;0.5,&gt;=0.4.1 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from tensorboard-&gt;detectron2) (0.4.6)
Requirement already satisfied: markdown&gt;=2.6.8 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from tensorboard-&gt;detectron2) (3.3.4)
Requirement already satisfied: tensorboard-plugin-wit&gt;=1.6.0 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from tensorboard-&gt;detectron2) (1.8.0)
Requirement already satisfied: pyasn1-modules&gt;=0.2.1 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from google-auth&lt;3,&gt;=1.6.3-&gt;tensorboard-&gt;detectron2) (0.2.8)
Requirement already satisfied: rsa&lt;5,&gt;=3.1.4 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from google-auth&lt;3,&gt;=1.6.3-&gt;tensorboard-&gt;detectron2) (4.7.2)
Requirement already satisfied: cachetools&lt;5.0,&gt;=2.0.0 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from google-auth&lt;3,&gt;=1.6.3-&gt;tensorboard-&gt;detectron2) (4.2.4)
Requirement already satisfied: requests-oauthlib&gt;=0.7.0 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from google-auth-oauthlib&lt;0.5,&gt;=0.4.1-&gt;tensorboard-&gt;detectron2) (1.3.0)
Requirement already satisfied: importlib-metadata in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from markdown&gt;=2.6.8-&gt;tensorboard-&gt;detectron2) (4.8.2)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: pyasn1&lt;0.5.0,&gt;=0.4.6 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from pyasn1-modules&gt;=0.2.1-&gt;google-auth&lt;3,&gt;=1.6.3-&gt;tensorboard-&gt;detectron2) (0.4.8)
Requirement already satisfied: certifi&gt;=2017.4.17 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from requests&lt;3,&gt;=2.21.0-&gt;tensorboard-&gt;detectron2) (2021.10.8)
Requirement already satisfied: idna&lt;4,&gt;=2.5 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from requests&lt;3,&gt;=2.21.0-&gt;tensorboard-&gt;detectron2) (3.3)
Requirement already satisfied: urllib3&lt;1.27,&gt;=1.21.1 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from requests&lt;3,&gt;=2.21.0-&gt;tensorboard-&gt;detectron2) (1.26.7)
Requirement already satisfied: charset-normalizer~=2.0.0 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from requests&lt;3,&gt;=2.21.0-&gt;tensorboard-&gt;detectron2) (2.0.7)
Requirement already satisfied: oauthlib&gt;=3.0.0 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from requests-oauthlib&gt;=0.7.0-&gt;google-auth-oauthlib&lt;0.5,&gt;=0.4.1-&gt;tensorboard-&gt;detectron2) (3.1.1)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import some common libraries</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="k">if</span> <span class="n">IN_COLAB</span><span class="p">:</span>
  <span class="kn">from</span> <span class="nn">google.colab.patches</span> <span class="kn">import</span> <span class="n">cv2_imshow</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Setup detectron2 logger</span>
<span class="kn">import</span> <span class="nn">detectron2</span>
<span class="kn">from</span> <span class="nn">detectron2.utils.logger</span> <span class="kn">import</span> <span class="n">setup_logger</span>
<span class="n">setup_logger</span><span class="p">()</span>

<span class="c1"># import some common detectron2 utilities</span>
<span class="kn">from</span> <span class="nn">detectron2</span> <span class="kn">import</span> <span class="n">model_zoo</span>
<span class="kn">from</span> <span class="nn">detectron2.engine</span> <span class="kn">import</span> <span class="n">DefaultPredictor</span>
<span class="kn">from</span> <span class="nn">detectron2.config</span> <span class="kn">import</span> <span class="n">get_cfg</span>
<span class="kn">from</span> <span class="nn">detectron2.utils.visualizer</span> <span class="kn">import</span> <span class="n">Visualizer</span>
<span class="kn">from</span> <span class="nn">detectron2.data</span> <span class="kn">import</span> <span class="n">MetadataCatalog</span><span class="p">,</span> <span class="n">DatasetCatalog</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># is there a gpu</span>
<span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
    <span class="n">GPU</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;gpu available&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">GPU</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;no gpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>no gpu
</pre></div>
</div>
</div>
</div>
<div class="section" id="upload-a-labeled-dataset">
<h2>Upload a labeled dataset.<a class="headerlink" href="#upload-a-labeled-dataset" title="Permalink to this headline">¶</a></h2>
<p>The following code is expecting the dataset in the COCO format to be in a <em><strong>.zip</strong></em> file. For example here we are going to use the example dataset we provide that is named <code class="docutils literal notranslate"><span class="pre">novelctrlk6_8_coco_dataset.zip</span></code> <br />
Note: please make sure there is no white space in your file path if you encounter file not found issues.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip install gdown
<span class="o">!</span>gdown --id 1fUXCLnoJ5SwXg54mj0NBKGzidsV8ALVR
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: gdown in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (4.2.0)
Requirement already satisfied: beautifulsoup4 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from gdown) (4.10.0)
Requirement already satisfied: tqdm in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from gdown) (4.62.3)
Requirement already satisfied: filelock in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from gdown) (3.4.2)
Requirement already satisfied: requests[socks] in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from gdown) (2.26.0)
Requirement already satisfied: six in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from gdown) (1.16.0)
Requirement already satisfied: soupsieve&gt;1.2 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from beautifulsoup4-&gt;gdown) (2.3.1)
Requirement already satisfied: idna&lt;4,&gt;=2.5 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from requests[socks]-&gt;gdown) (3.3)
Requirement already satisfied: urllib3&lt;1.27,&gt;=1.21.1 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from requests[socks]-&gt;gdown) (1.26.7)
Requirement already satisfied: certifi&gt;=2017.4.17 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from requests[socks]-&gt;gdown) (2021.10.8)
Requirement already satisfied: charset-normalizer~=2.0.0 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from requests[socks]-&gt;gdown) (2.0.7)
Requirement already satisfied: PySocks!=1.5.7,&gt;=1.5.6 in /home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages (from requests[socks]-&gt;gdown) (1.7.1)
Downloading...
From: https://drive.google.com/uc?id=1fUXCLnoJ5SwXg54mj0NBKGzidsV8ALVR
To: /mnt/home_nas/jeremy/Recherches/Postdoc/CPLab/Projects/Annolid/annolid/book/tutorials/novelctrlk6_8_coco_dataset.zip
100%|██████████████████████████████████████| 10.3M/10.3M [00:00&lt;00:00, 13.2MB/s]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">IN_COLAB</span><span class="p">:</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="s1">&#39;content/novelctrlk6_8_coco_dataset.zip&#39;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="s1">&#39;novelctrlk6_8_coco_dataset.zip&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">IN_COLAB</span><span class="p">:</span>
    <span class="o">!</span>unzip <span class="nv">$dataset</span> -d /content/
<span class="k">else</span><span class="p">:</span>
    <span class="c1">#TODO generalize this</span>
    <span class="o">!</span>unzip -o <span class="nv">$dataset</span> -d .
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Archive:  novelctrlk6_8_coco_dataset.zip
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00001416_41.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00004233_81.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00004515_22.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00000636_6.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00006297_11.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00006818_79.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00006056_25.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00006094_12.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00004340_96.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00000557_50.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00000979_94.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00005018_19.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00001257_80.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00004335_26.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00004804_39.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00006396_43.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00006993_65.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00000865_92.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00003114_35.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00001918_2.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00004935_56.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00006959_78.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00005216_14.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00003092_22.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00001528_44.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00003208_12.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00004966_35.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00004517_47.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00004769_82.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00004767_87.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00000378_62.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00006563_31.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00001476_48.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00004555_67.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00003070_62.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00005007_38.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00003342_41.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00002267_91.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00002248_99.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00000702_46.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00003237_15.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00002412_96.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00001322_73.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00002328_97.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00004312_85.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00004443_46.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00003783_81.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00000779_3.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00002654_1.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00004685_90.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00004098_59.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00006538_99.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00006832_71.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00007024_26.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00005772_51.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00006330_76.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00000871_10.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00003034_64.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00004539_89.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/JPEGImages/00005788_49.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/valid/annotations.json  
  inflating: ./novelctrlk6_8_coco_dataset/.DS_Store  
  inflating: ./__MACOSX/novelctrlk6_8_coco_dataset/._.DS_Store  
  inflating: ./novelctrlk6_8_coco_dataset/data.yaml  
  inflating: ./novelctrlk6_8_coco_dataset/train/.DS_Store  
  inflating: ./__MACOSX/novelctrlk6_8_coco_dataset/train/._.DS_Store  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00001466_29.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00006804_57.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00007044_50.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00006232_55.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00000759_28.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00003680_32.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00004441_88.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00005090_94.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00002476_27.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00000965_42.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00001652_55.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00002000_18.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00002333_0.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00005752_39.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00006670_0.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00005763_18.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00004469_75.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00005566_43.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00004336_74.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00006574_88.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00001922_1.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00001795_5.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00005755_34.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00003576_54.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00002647_78.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00004295_47.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00003667_56.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00006131_85.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00000311_77.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00000879_40.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00002991_7.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00000757_5.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00004628_68.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00004348_33.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00003269_66.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00003224_49.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00002628_21.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00001838_25.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00002825_40.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00002247_29.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00003100_30.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00001922_57.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00001320_92.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00006299_63.jpg  
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00000952_60.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00000842_70.jpg  
  inflating: ./__MACOSX/novelctrlk6_8_coco_dataset/train/JPEGImages/._00000842_70.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00002295_32.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00004117_59.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00003976_44.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00004032_20.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00006212_69.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00003134_31.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00006169_98.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00006830_36.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00004570_24.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00000735_23.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00003905_42.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00003012_37.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00005456_95.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00002456_9.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00002433_90.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00006715_97.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00005597_15.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00006319_53.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00005025_83.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00000530_64.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00002362_63.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00002311_72.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00005068_37.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00006353_11.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00005056_91.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00000970_34.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00002577_24.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00006601_16.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00000652_65.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00002639_95.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00005953_8.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00006000_27.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00005700_89.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00004672_51.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00004062_19.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00005246_28.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00005154_53.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00005584_93.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00003834_80.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00004711_6.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00006038_20.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00006373_2.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00006470_84.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00003956_16.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00002625_79.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00006270_45.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00006521_86.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00001999_45.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00004081_4.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00000776_14.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00002546_58.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00001181_61.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00002226_87.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00001632_33.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00006218_71.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00005400_9.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00001299_86.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00002067_75.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00006844_69.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00001892_72.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00001153_93.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00001389_82.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00001439_52.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00006367_98.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00004018_67.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00004535_48.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00006361_13.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00003167_10.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00006832_66.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00004956_38.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00001980_61.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/JPEGImages/00003364_13.jpg  
  inflating: ./novelctrlk6_8_coco_dataset/train/annotations.json  
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DATASET_NAME</span> <span class="o">=</span> <span class="n">DATASET_DIR</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dataset</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.zip&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="run-a-pre-trained-detectron2-model">
<h1>Run a pre-trained detectron2 model<a class="headerlink" href="#run-a-pre-trained-detectron2-model" title="Permalink to this headline">¶</a></h1>
<p>First, we check a random selected image from our training dataset:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># select and display one random image from the training set</span>
<span class="n">img_file</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DATASET_DIR</span><span class="si">}</span><span class="s2">/train/JPEGImages/*.*&quot;</span><span class="p">))</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_file</span><span class="p">)</span>
<span class="k">if</span> <span class="n">IN_COLAB</span><span class="p">:</span>
    <span class="n">cv2_imshow</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/Annolid_on_Detectron2_Tutorial_Example_Dataset_15_0.png" src="../_images/Annolid_on_Detectron2_Tutorial_Example_Dataset_15_0.png" />
</div>
</div>
<p>Then, we create a Detectron2 config and a detectron2 <code class="docutils literal notranslate"><span class="pre">DefaultPredictor</span></code> to run inference on this image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cfg</span> <span class="o">=</span> <span class="n">get_cfg</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">GPU</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">MODEL</span><span class="o">.</span><span class="n">DEVICE</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># add project-specific config (e.g., TensorMask) here if you&#39;re not running a model in detectron2&#39;s core library</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">merge_from_file</span><span class="p">(</span><span class="n">model_zoo</span><span class="o">.</span><span class="n">get_config_file</span><span class="p">(</span><span class="s2">&quot;COCO-InstanceSegmentation/mask_rcnn_R_50_FPN_3x.yaml&quot;</span><span class="p">))</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">MODEL</span><span class="o">.</span><span class="n">ROI_HEADS</span><span class="o">.</span><span class="n">SCORE_THRESH_TEST</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># set threshold for this model</span>
<span class="c1"># Find a model from Detectron2&#39;s model zoo. You can use the https://dl.fbaipublicfiles... url as well</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">MODEL</span><span class="o">.</span><span class="n">WEIGHTS</span> <span class="o">=</span> <span class="n">model_zoo</span><span class="o">.</span><span class="n">get_checkpoint_url</span><span class="p">(</span><span class="s2">&quot;COCO-InstanceSegmentation/mask_rcnn_R_50_FPN_3x.yaml&quot;</span><span class="p">)</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">DefaultPredictor</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
<span class="n">outputs</span> <span class="o">=</span> <span class="n">predictor</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages/detectron2/structures/image_list.py:88: UserWarning: __floordiv__ is deprecated, and its behavior will change in a future version of pytorch. It currently rounds toward 0 (like the &#39;trunc&#39; function NOT &#39;floor&#39;). This results in incorrect rounding for negative values. To keep the current behavior, use torch.div(a, b, rounding_mode=&#39;trunc&#39;), or for actual floor division, use torch.div(a, b, rounding_mode=&#39;floor&#39;).
  max_size = (max_size + (stride - 1)) // stride * stride
/home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages/torch/functional.py:445: UserWarning: torch.meshgrid: in an upcoming release, it will be required to pass the indexing argument. (Triggered internally at  ../aten/src/ATen/native/TensorShape.cpp:2157.)
  return _VF.meshgrid(tensors, **kwargs)  # type: ignore[attr-defined]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># look at the outputs. See https://detectron2.readthedocs.io/tutorials/models.html#model-output-format for specification</span>
<span class="nb">print</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;instances&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pred_classes</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;instances&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pred_boxes</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>tensor([ 6, 65, 74, 74, 56])
Boxes(tensor([[  75.6154,   37.8977, 1273.1077,  985.7012],
        [  18.1820,  134.1059,  163.1887,  981.1087],
        [ 898.1162,  518.6722,  948.0486,  567.4241],
        [ 504.1673,  541.2513,  551.8248,  588.9865],
        [   0.0000,   35.3450,  163.4191, 1012.4688]]))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;instances&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pred_masks</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>tensor([[[False, False, False,  ..., False, False, False],
         [False, False, False,  ..., False, False, False],
         [False, False, False,  ..., False, False, False],
         ...,
         [False, False, False,  ..., False, False, False],
         [False, False, False,  ..., False, False, False],
         [False, False, False,  ..., False, False, False]],

        [[False, False, False,  ..., False, False, False],
         [False, False, False,  ..., False, False, False],
         [False, False, False,  ..., False, False, False],
         ...,
         [False, False, False,  ..., False, False, False],
         [False, False, False,  ..., False, False, False],
         [False, False, False,  ..., False, False, False]],

        [[False, False, False,  ..., False, False, False],
         [False, False, False,  ..., False, False, False],
         [False, False, False,  ..., False, False, False],
         ...,
         [False, False, False,  ..., False, False, False],
         [False, False, False,  ..., False, False, False],
         [False, False, False,  ..., False, False, False]],

        [[False, False, False,  ..., False, False, False],
         [False, False, False,  ..., False, False, False],
         [False, False, False,  ..., False, False, False],
         ...,
         [False, False, False,  ..., False, False, False],
         [False, False, False,  ..., False, False, False],
         [False, False, False,  ..., False, False, False]],

        [[False, False, False,  ..., False, False, False],
         [False, False, False,  ..., False, False, False],
         [False, False, False,  ..., False, False, False],
         ...,
         [False, False, False,  ..., False, False, False],
         [False, False, False,  ..., False, False, False],
         [False, False, False,  ..., False, False, False]]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">MetadataCatalog</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">DATASETS</span><span class="o">.</span><span class="n">TRAIN</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>namespace(name=&#39;coco_2017_train&#39;,
          json_file=&#39;datasets/coco/annotations/instances_train2017.json&#39;,
          image_root=&#39;datasets/coco/train2017&#39;,
          evaluator_type=&#39;coco&#39;,
          thing_dataset_id_to_contiguous_id={1: 0,
                                             2: 1,
                                             3: 2,
                                             4: 3,
                                             5: 4,
                                             6: 5,
                                             7: 6,
                                             8: 7,
                                             9: 8,
                                             10: 9,
                                             11: 10,
                                             13: 11,
                                             14: 12,
                                             15: 13,
                                             16: 14,
                                             17: 15,
                                             18: 16,
                                             19: 17,
                                             20: 18,
                                             21: 19,
                                             22: 20,
                                             23: 21,
                                             24: 22,
                                             25: 23,
                                             27: 24,
                                             28: 25,
                                             31: 26,
                                             32: 27,
                                             33: 28,
                                             34: 29,
                                             35: 30,
                                             36: 31,
                                             37: 32,
                                             38: 33,
                                             39: 34,
                                             40: 35,
                                             41: 36,
                                             42: 37,
                                             43: 38,
                                             44: 39,
                                             46: 40,
                                             47: 41,
                                             48: 42,
                                             49: 43,
                                             50: 44,
                                             51: 45,
                                             52: 46,
                                             53: 47,
                                             54: 48,
                                             55: 49,
                                             56: 50,
                                             57: 51,
                                             58: 52,
                                             59: 53,
                                             60: 54,
                                             61: 55,
                                             62: 56,
                                             63: 57,
                                             64: 58,
                                             65: 59,
                                             67: 60,
                                             70: 61,
                                             72: 62,
                                             73: 63,
                                             74: 64,
                                             75: 65,
                                             76: 66,
                                             77: 67,
                                             78: 68,
                                             79: 69,
                                             80: 70,
                                             81: 71,
                                             82: 72,
                                             84: 73,
                                             85: 74,
                                             86: 75,
                                             87: 76,
                                             88: 77,
                                             89: 78,
                                             90: 79},
          thing_classes=[&#39;person&#39;,
                         &#39;bicycle&#39;,
                         &#39;car&#39;,
                         &#39;motorcycle&#39;,
                         &#39;airplane&#39;,
                         &#39;bus&#39;,
                         &#39;train&#39;,
                         &#39;truck&#39;,
                         &#39;boat&#39;,
                         &#39;traffic light&#39;,
                         &#39;fire hydrant&#39;,
                         &#39;stop sign&#39;,
                         &#39;parking meter&#39;,
                         &#39;bench&#39;,
                         &#39;bird&#39;,
                         &#39;cat&#39;,
                         &#39;dog&#39;,
                         &#39;horse&#39;,
                         &#39;sheep&#39;,
                         &#39;cow&#39;,
                         &#39;elephant&#39;,
                         &#39;bear&#39;,
                         &#39;zebra&#39;,
                         &#39;giraffe&#39;,
                         &#39;backpack&#39;,
                         &#39;umbrella&#39;,
                         &#39;handbag&#39;,
                         &#39;tie&#39;,
                         &#39;suitcase&#39;,
                         &#39;frisbee&#39;,
                         &#39;skis&#39;,
                         &#39;snowboard&#39;,
                         &#39;sports ball&#39;,
                         &#39;kite&#39;,
                         &#39;baseball bat&#39;,
                         &#39;baseball glove&#39;,
                         &#39;skateboard&#39;,
                         &#39;surfboard&#39;,
                         &#39;tennis racket&#39;,
                         &#39;bottle&#39;,
                         &#39;wine glass&#39;,
                         &#39;cup&#39;,
                         &#39;fork&#39;,
                         &#39;knife&#39;,
                         &#39;spoon&#39;,
                         &#39;bowl&#39;,
                         &#39;banana&#39;,
                         &#39;apple&#39;,
                         &#39;sandwich&#39;,
                         &#39;orange&#39;,
                         &#39;broccoli&#39;,
                         &#39;carrot&#39;,
                         &#39;hot dog&#39;,
                         &#39;pizza&#39;,
                         &#39;donut&#39;,
                         &#39;cake&#39;,
                         &#39;chair&#39;,
                         &#39;couch&#39;,
                         &#39;potted plant&#39;,
                         &#39;bed&#39;,
                         &#39;dining table&#39;,
                         &#39;toilet&#39;,
                         &#39;tv&#39;,
                         &#39;laptop&#39;,
                         &#39;mouse&#39;,
                         &#39;remote&#39;,
                         &#39;keyboard&#39;,
                         &#39;cell phone&#39;,
                         &#39;microwave&#39;,
                         &#39;oven&#39;,
                         &#39;toaster&#39;,
                         &#39;sink&#39;,
                         &#39;refrigerator&#39;,
                         &#39;book&#39;,
                         &#39;clock&#39;,
                         &#39;vase&#39;,
                         &#39;scissors&#39;,
                         &#39;teddy bear&#39;,
                         &#39;hair drier&#39;,
                         &#39;toothbrush&#39;],
          thing_colors=[[220, 20, 60],
                        [119, 11, 32],
                        [0, 0, 142],
                        [0, 0, 230],
                        [106, 0, 228],
                        [0, 60, 100],
                        [0, 80, 100],
                        [0, 0, 70],
                        [0, 0, 192],
                        [250, 170, 30],
                        [100, 170, 30],
                        [220, 220, 0],
                        [175, 116, 175],
                        [250, 0, 30],
                        [165, 42, 42],
                        [255, 77, 255],
                        [0, 226, 252],
                        [182, 182, 255],
                        [0, 82, 0],
                        [120, 166, 157],
                        [110, 76, 0],
                        [174, 57, 255],
                        [199, 100, 0],
                        [72, 0, 118],
                        [255, 179, 240],
                        [0, 125, 92],
                        [209, 0, 151],
                        [188, 208, 182],
                        [0, 220, 176],
                        [255, 99, 164],
                        [92, 0, 73],
                        [133, 129, 255],
                        [78, 180, 255],
                        [0, 228, 0],
                        [174, 255, 243],
                        [45, 89, 255],
                        [134, 134, 103],
                        [145, 148, 174],
                        [255, 208, 186],
                        [197, 226, 255],
                        [171, 134, 1],
                        [109, 63, 54],
                        [207, 138, 255],
                        [151, 0, 95],
                        [9, 80, 61],
                        [84, 105, 51],
                        [74, 65, 105],
                        [166, 196, 102],
                        [208, 195, 210],
                        [255, 109, 65],
                        [0, 143, 149],
                        [179, 0, 194],
                        [209, 99, 106],
                        [5, 121, 0],
                        [227, 255, 205],
                        [147, 186, 208],
                        [153, 69, 1],
                        [3, 95, 161],
                        [163, 255, 0],
                        [119, 0, 170],
                        [0, 182, 199],
                        [0, 165, 120],
                        [183, 130, 88],
                        [95, 32, 0],
                        [130, 114, 135],
                        [110, 129, 133],
                        [166, 74, 118],
                        [219, 142, 185],
                        [79, 210, 114],
                        [178, 90, 62],
                        [65, 70, 15],
                        [127, 167, 115],
                        [59, 105, 106],
                        [142, 108, 45],
                        [196, 172, 0],
                        [95, 54, 80],
                        [128, 76, 255],
                        [201, 57, 1],
                        [246, 0, 122],
                        [191, 162, 208]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We can use `Visualizer` to draw the predictions on the image.</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">Visualizer</span><span class="p">(</span><span class="n">im</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">MetadataCatalog</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">DATASETS</span><span class="o">.</span><span class="n">TRAIN</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.2</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">draw_instance_predictions</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;instances&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">))</span>
<span class="k">if</span> <span class="n">IN_COLAB</span><span class="p">:</span>
    <span class="n">cv2_imshow</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">get_image</span><span class="p">()[:,</span> <span class="p">:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">get_image</span><span class="p">()[:,</span> <span class="p">:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/Annolid_on_Detectron2_Tutorial_Example_Dataset_23_0.png" src="../_images/Annolid_on_Detectron2_Tutorial_Example_Dataset_23_0.png" />
</div>
</div>
<p>As we can see, the network doesn’t detect what we want. That is expected as we have not fine-tuned the network with our custom dataset. We are going to do that in the next steps.</p>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="train-on-a-custom-dataset">
<h1>Train on a custom dataset<a class="headerlink" href="#train-on-a-custom-dataset" title="Permalink to this headline">¶</a></h1>
<p>In this section, we show how to train an existing detectron2 model on a custom dataset in COCO format.</p>
<div class="section" id="prepare-the-dataset">
<h2>Prepare the dataset<a class="headerlink" href="#prepare-the-dataset" title="Permalink to this headline">¶</a></h2>
<p>Register the custom dataset to Detectron2, following the <a class="reference external" href="https://detectron2.readthedocs.io/tutorials/datasets.html">detectron2 custom dataset tutorial</a>.
Here, the dataset is in COCO format, therefore we register  into Detectron2’s standard format. User should write such a function when using a dataset in custom format. See the tutorial for more details.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">detectron2.data.datasets</span> <span class="kn">import</span> <span class="n">register_coco_instances</span>
<span class="kn">from</span> <span class="nn">detectron2.data</span> <span class="kn">import</span> <span class="n">get_detection_dataset_dicts</span>
<span class="kn">from</span> <span class="nn">detectron2.data.datasets</span> <span class="kn">import</span>  <span class="n">builtin_meta</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">register_coco_instances</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DATASET_NAME</span><span class="si">}</span><span class="s2">_train&quot;</span><span class="p">,</span> <span class="p">{},</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DATASET_DIR</span><span class="si">}</span><span class="s2">/train/annotations.json&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DATASET_DIR</span><span class="si">}</span><span class="s2">/train/&quot;</span><span class="p">)</span>
<span class="n">register_coco_instances</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DATASET_NAME</span><span class="si">}</span><span class="s2">_valid&quot;</span><span class="p">,</span> <span class="p">{},</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DATASET_DIR</span><span class="si">}</span><span class="s2">/valid/annotations.json&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DATASET_DIR</span><span class="si">}</span><span class="s2">/valid/&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset_dicts</span> <span class="o">=</span> <span class="n">get_detection_dataset_dicts</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DATASET_NAME</span><span class="si">}</span><span class="s2">_train&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Green">[01/21 05:30:27 d2.data.datasets.coco]: </span>Loaded 118 images in COCO format from novelctrlk6_8_coco_dataset/train/annotations.json
<span class=" -Color -Color-Green">[01/21 05:30:27 d2.data.build]: </span>Removed 0 images with no usable annotations. 118 images left.
<span class=" -Color -Color-Green">[01/21 05:30:27 d2.data.build]: </span>Distribution of instances among all 7 categories:
<span class=" -Color -Color-Cyan">|   category   | #instances   |  category  | #instances   |  category  | #instances   |</span>
<span class=" -Color -Color-Cyan">|:------------:|:-------------|:----------:|:-------------|:----------:|:-------------|</span>
<span class=" -Color -Color-Cyan">| _background_ | 0            |    nose    | 118          |  left_ear  | 118          |</span>
<span class=" -Color -Color-Cyan">|  right_ear   | 117          | tail_base  | 119          |   mouse    | 118          |</span>
<span class=" -Color -Color-Cyan">|   centroid   | 1            |            |              |            |              |</span>
<span class=" -Color -Color-Cyan">|    total     | 591          |            |              |            |              |</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_dataset_metadata</span> <span class="o">=</span> <span class="n">MetadataCatalog</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DATASET_NAME</span><span class="si">}</span><span class="s2">_train&quot;</span><span class="p">)</span>
<span class="n">_dataset_metadata</span><span class="o">.</span><span class="n">thing_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cc</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">builtin_meta</span><span class="o">.</span><span class="n">COCO_CATEGORIES</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_dataset_metadata</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>namespace(name=&#39;novelctrlk6_8_coco_dataset_train&#39;,
          json_file=&#39;novelctrlk6_8_coco_dataset/train/annotations.json&#39;,
          image_root=&#39;novelctrlk6_8_coco_dataset/train/&#39;,
          evaluator_type=&#39;coco&#39;,
          thing_classes=[&#39;_background_&#39;,
                         &#39;nose&#39;,
                         &#39;left_ear&#39;,
                         &#39;right_ear&#39;,
                         &#39;tail_base&#39;,
                         &#39;mouse&#39;,
                         &#39;centroid&#39;],
          thing_dataset_id_to_contiguous_id={0: 0,
                                             1: 1,
                                             2: 2,
                                             3: 3,
                                             4: 4,
                                             5: 5,
                                             6: 6},
          thing_colors=[[220, 20, 60],
                        [119, 11, 32],
                        [0, 0, 142],
                        [0, 0, 230],
                        [106, 0, 228],
                        [0, 60, 100],
                        [0, 80, 100],
                        [0, 0, 70],
                        [0, 0, 192],
                        [250, 170, 30],
                        [100, 170, 30],
                        [220, 220, 0],
                        [175, 116, 175],
                        [250, 0, 30],
                        [165, 42, 42],
                        [255, 77, 255],
                        [0, 226, 252],
                        [182, 182, 255],
                        [0, 82, 0],
                        [120, 166, 157],
                        [110, 76, 0],
                        [174, 57, 255],
                        [199, 100, 0],
                        [72, 0, 118],
                        [255, 179, 240],
                        [0, 125, 92],
                        [209, 0, 151],
                        [188, 208, 182],
                        [0, 220, 176],
                        [255, 99, 164],
                        [92, 0, 73],
                        [133, 129, 255],
                        [78, 180, 255],
                        [0, 228, 0],
                        [174, 255, 243],
                        [45, 89, 255],
                        [134, 134, 103],
                        [145, 148, 174],
                        [255, 208, 186],
                        [197, 226, 255],
                        [171, 134, 1],
                        [109, 63, 54],
                        [207, 138, 255],
                        [151, 0, 95],
                        [9, 80, 61],
                        [84, 105, 51],
                        [74, 65, 105],
                        [166, 196, 102],
                        [208, 195, 210],
                        [255, 109, 65],
                        [0, 143, 149],
                        [179, 0, 194],
                        [209, 99, 106],
                        [5, 121, 0],
                        [227, 255, 205],
                        [147, 186, 208],
                        [153, 69, 1],
                        [3, 95, 161],
                        [163, 255, 0],
                        [119, 0, 170],
                        [0, 182, 199],
                        [0, 165, 120],
                        [183, 130, 88],
                        [95, 32, 0],
                        [130, 114, 135],
                        [110, 129, 133],
                        [166, 74, 118],
                        [219, 142, 185],
                        [79, 210, 114],
                        [178, 90, 62],
                        [65, 70, 15],
                        [127, 167, 115],
                        [59, 105, 106],
                        [142, 108, 45],
                        [196, 172, 0],
                        [95, 54, 80],
                        [128, 76, 255],
                        [201, 57, 1],
                        [246, 0, 122],
                        [191, 162, 208],
                        [255, 255, 128],
                        [147, 211, 203],
                        [150, 100, 100],
                        [168, 171, 172],
                        [146, 112, 198],
                        [210, 170, 100],
                        [92, 136, 89],
                        [218, 88, 184],
                        [241, 129, 0],
                        [217, 17, 255],
                        [124, 74, 181],
                        [70, 70, 70],
                        [255, 228, 255],
                        [154, 208, 0],
                        [193, 0, 92],
                        [76, 91, 113],
                        [255, 180, 195],
                        [106, 154, 176],
                        [230, 150, 140],
                        [60, 143, 255],
                        [128, 64, 128],
                        [92, 82, 55],
                        [254, 212, 124],
                        [73, 77, 174],
                        [255, 160, 98],
                        [255, 255, 255],
                        [104, 84, 109],
                        [169, 164, 131],
                        [225, 199, 255],
                        [137, 54, 74],
                        [135, 158, 223],
                        [7, 246, 231],
                        [107, 255, 200],
                        [58, 41, 149],
                        [183, 121, 142],
                        [255, 73, 97],
                        [107, 142, 35],
                        [190, 153, 153],
                        [146, 139, 141],
                        [70, 130, 180],
                        [134, 199, 156],
                        [209, 226, 140],
                        [96, 36, 108],
                        [96, 96, 96],
                        [64, 170, 64],
                        [152, 251, 152],
                        [208, 229, 228],
                        [206, 186, 171],
                        [152, 161, 64],
                        [116, 112, 0],
                        [0, 114, 143],
                        [102, 102, 156],
                        [250, 141, 255]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NUM_CLASSES</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_dataset_metadata</span><span class="o">.</span><span class="n">thing_classes</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">NUM_CLASSES</span><span class="si">}</span><span class="s2"> Number of classes in the dataset&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>7 Number of classes in the dataset
</pre></div>
</div>
</div>
</div>
<p>To verify the data loading is correct, let’s visualize the annotations of a randomly selected sample in the training set:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">dataset_dicts</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]:</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;file_name&quot;</span><span class="p">])</span>
    <span class="n">visualizer</span> <span class="o">=</span> <span class="n">Visualizer</span><span class="p">(</span><span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">metadata</span><span class="o">=</span><span class="n">_dataset_metadata</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">visualizer</span><span class="o">.</span><span class="n">draw_dataset_dict</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">IN_COLAB</span><span class="p">:</span>
        <span class="n">cv2_imshow</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">get_image</span><span class="p">()[:,</span> <span class="p">:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">get_image</span><span class="p">()[:,</span> <span class="p">:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/Annolid_on_Detectron2_Tutorial_Example_Dataset_35_0.png" src="../_images/Annolid_on_Detectron2_Tutorial_Example_Dataset_35_0.png" />
</div>
</div>
</div>
<div class="section" id="train">
<h2>Train!<a class="headerlink" href="#train" title="Permalink to this headline">¶</a></h2>
<p>Now, let’s fine-tune the COCO-pretrained R50-FPN Mask R-CNN model with our custom dataset. It takes ~2 hours to train 3000 iterations on Colab’s K80 GPU, or ~1.5 hours on a P100 GPU.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">GPU</span><span class="p">:</span>
    <span class="o">!</span>nvidia-smi
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">detectron2.engine</span> <span class="kn">import</span> <span class="n">DefaultTrainer</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cfg</span> <span class="o">=</span> <span class="n">get_cfg</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">GPU</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">MODEL</span><span class="o">.</span><span class="n">DEVICE</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cfg</span><span class="o">.</span><span class="n">merge_from_file</span><span class="p">(</span><span class="n">model_zoo</span><span class="o">.</span><span class="n">get_config_file</span><span class="p">(</span><span class="s2">&quot;COCO-InstanceSegmentation/mask_rcnn_R_50_FPN_3x.yaml&quot;</span><span class="p">))</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">DATASETS</span><span class="o">.</span><span class="n">TRAIN</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DATASET_NAME</span><span class="si">}</span><span class="s2">_train&quot;</span><span class="p">,)</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">DATASETS</span><span class="o">.</span><span class="n">TEST</span> <span class="o">=</span> <span class="p">()</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">DATALOADER</span><span class="o">.</span><span class="n">NUM_WORKERS</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1">#@param</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">DATALOADER</span><span class="o">.</span><span class="n">SAMPLER_TRAIN</span> <span class="o">=</span> <span class="s2">&quot;RepeatFactorTrainingSampler&quot;</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">DATALOADER</span><span class="o">.</span><span class="n">REPEAT_THRESHOLD</span> <span class="o">=</span> <span class="mf">0.3</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">MODEL</span><span class="o">.</span><span class="n">WEIGHTS</span> <span class="o">=</span> <span class="n">model_zoo</span><span class="o">.</span><span class="n">get_checkpoint_url</span><span class="p">(</span><span class="s2">&quot;COCO-InstanceSegmentation/mask_rcnn_R_50_FPN_3x.yaml&quot;</span><span class="p">)</span>  <span class="c1"># Let training initialize from model zoo</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">SOLVER</span><span class="o">.</span><span class="n">IMS_PER_BATCH</span> <span class="o">=</span>  <span class="mi">8</span> <span class="c1">#@param</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">SOLVER</span><span class="o">.</span><span class="n">BASE_LR</span> <span class="o">=</span> <span class="mf">0.0025</span> <span class="c1">#@param # pick a good LR</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">SOLVER</span><span class="o">.</span><span class="n">MAX_ITER</span> <span class="o">=</span> <span class="mi">3000</span> <span class="c1">#@param    # 300 iterations seems good enough for 100 frames dataset; you will need to train longer for a practical dataset</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">SOLVER</span><span class="o">.</span><span class="n">CHECKPOINT_PERIOD</span> <span class="o">=</span> <span class="mi">1000</span> <span class="c1">#@param </span>
<span class="n">cfg</span><span class="o">.</span><span class="n">MODEL</span><span class="o">.</span><span class="n">ROI_HEADS</span><span class="o">.</span><span class="n">BATCH_SIZE_PER_IMAGE</span> <span class="o">=</span> <span class="mi">128</span> <span class="c1">#@param   # faster, and good enough for this toy dataset (default: 512)</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">MODEL</span><span class="o">.</span><span class="n">ROI_HEADS</span><span class="o">.</span><span class="n">NUM_CLASSES</span> <span class="o">=</span> <span class="n">NUM_CLASSES</span>  <span class="c1">#  (see https://detectron2.readthedocs.io/tutorials/datasets.html#update-the-config-for-new-datasets)</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">OUTPUT_DIR</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">trainer</span> <span class="o">=</span> <span class="n">DefaultTrainer</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span> 
<span class="n">trainer</span><span class="o">.</span><span class="n">resume_or_load</span><span class="p">(</span><span class="n">resume</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Green">[01/21 05:30:28 d2.engine.defaults]: </span>Model:
GeneralizedRCNN(
  (backbone): FPN(
    (fpn_lateral2): Conv2d(256, 256, kernel_size=(1, 1), stride=(1, 1))
    (fpn_output2): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (fpn_lateral3): Conv2d(512, 256, kernel_size=(1, 1), stride=(1, 1))
    (fpn_output3): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (fpn_lateral4): Conv2d(1024, 256, kernel_size=(1, 1), stride=(1, 1))
    (fpn_output4): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (fpn_lateral5): Conv2d(2048, 256, kernel_size=(1, 1), stride=(1, 1))
    (fpn_output5): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (top_block): LastLevelMaxPool()
    (bottom_up): ResNet(
      (stem): BasicStem(
        (conv1): Conv2d(
          3, 64, kernel_size=(7, 7), stride=(2, 2), padding=(3, 3), bias=False
          (norm): FrozenBatchNorm2d(num_features=64, eps=1e-05)
        )
      )
      (res2): Sequential(
        (0): BottleneckBlock(
          (shortcut): Conv2d(
            64, 256, kernel_size=(1, 1), stride=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=256, eps=1e-05)
          )
          (conv1): Conv2d(
            64, 64, kernel_size=(1, 1), stride=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=64, eps=1e-05)
          )
          (conv2): Conv2d(
            64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=64, eps=1e-05)
          )
          (conv3): Conv2d(
            64, 256, kernel_size=(1, 1), stride=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=256, eps=1e-05)
          )
        )
        (1): BottleneckBlock(
          (conv1): Conv2d(
            256, 64, kernel_size=(1, 1), stride=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=64, eps=1e-05)
          )
          (conv2): Conv2d(
            64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=64, eps=1e-05)
          )
          (conv3): Conv2d(
            64, 256, kernel_size=(1, 1), stride=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=256, eps=1e-05)
          )
        )
        (2): BottleneckBlock(
          (conv1): Conv2d(
            256, 64, kernel_size=(1, 1), stride=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=64, eps=1e-05)
          )
          (conv2): Conv2d(
            64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=64, eps=1e-05)
          )
          (conv3): Conv2d(
            64, 256, kernel_size=(1, 1), stride=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=256, eps=1e-05)
          )
        )
      )
      (res3): Sequential(
        (0): BottleneckBlock(
          (shortcut): Conv2d(
            256, 512, kernel_size=(1, 1), stride=(2, 2), bias=False
            (norm): FrozenBatchNorm2d(num_features=512, eps=1e-05)
          )
          (conv1): Conv2d(
            256, 128, kernel_size=(1, 1), stride=(2, 2), bias=False
            (norm): FrozenBatchNorm2d(num_features=128, eps=1e-05)
          )
          (conv2): Conv2d(
            128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=128, eps=1e-05)
          )
          (conv3): Conv2d(
            128, 512, kernel_size=(1, 1), stride=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=512, eps=1e-05)
          )
        )
        (1): BottleneckBlock(
          (conv1): Conv2d(
            512, 128, kernel_size=(1, 1), stride=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=128, eps=1e-05)
          )
          (conv2): Conv2d(
            128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=128, eps=1e-05)
          )
          (conv3): Conv2d(
            128, 512, kernel_size=(1, 1), stride=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=512, eps=1e-05)
          )
        )
        (2): BottleneckBlock(
          (conv1): Conv2d(
            512, 128, kernel_size=(1, 1), stride=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=128, eps=1e-05)
          )
          (conv2): Conv2d(
            128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=128, eps=1e-05)
          )
          (conv3): Conv2d(
            128, 512, kernel_size=(1, 1), stride=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=512, eps=1e-05)
          )
        )
        (3): BottleneckBlock(
          (conv1): Conv2d(
            512, 128, kernel_size=(1, 1), stride=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=128, eps=1e-05)
          )
          (conv2): Conv2d(
            128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=128, eps=1e-05)
          )
          (conv3): Conv2d(
            128, 512, kernel_size=(1, 1), stride=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=512, eps=1e-05)
          )
        )
      )
      (res4): Sequential(
        (0): BottleneckBlock(
          (shortcut): Conv2d(
            512, 1024, kernel_size=(1, 1), stride=(2, 2), bias=False
            (norm): FrozenBatchNorm2d(num_features=1024, eps=1e-05)
          )
          (conv1): Conv2d(
            512, 256, kernel_size=(1, 1), stride=(2, 2), bias=False
            (norm): FrozenBatchNorm2d(num_features=256, eps=1e-05)
          )
          (conv2): Conv2d(
            256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=256, eps=1e-05)
          )
          (conv3): Conv2d(
            256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=1024, eps=1e-05)
          )
        )
        (1): BottleneckBlock(
          (conv1): Conv2d(
            1024, 256, kernel_size=(1, 1), stride=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=256, eps=1e-05)
          )
          (conv2): Conv2d(
            256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=256, eps=1e-05)
          )
          (conv3): Conv2d(
            256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=1024, eps=1e-05)
          )
        )
        (2): BottleneckBlock(
          (conv1): Conv2d(
            1024, 256, kernel_size=(1, 1), stride=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=256, eps=1e-05)
          )
          (conv2): Conv2d(
            256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=256, eps=1e-05)
          )
          (conv3): Conv2d(
            256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=1024, eps=1e-05)
          )
        )
        (3): BottleneckBlock(
          (conv1): Conv2d(
            1024, 256, kernel_size=(1, 1), stride=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=256, eps=1e-05)
          )
          (conv2): Conv2d(
            256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=256, eps=1e-05)
          )
          (conv3): Conv2d(
            256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=1024, eps=1e-05)
          )
        )
        (4): BottleneckBlock(
          (conv1): Conv2d(
            1024, 256, kernel_size=(1, 1), stride=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=256, eps=1e-05)
          )
          (conv2): Conv2d(
            256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=256, eps=1e-05)
          )
          (conv3): Conv2d(
            256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=1024, eps=1e-05)
          )
        )
        (5): BottleneckBlock(
          (conv1): Conv2d(
            1024, 256, kernel_size=(1, 1), stride=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=256, eps=1e-05)
          )
          (conv2): Conv2d(
            256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=256, eps=1e-05)
          )
          (conv3): Conv2d(
            256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=1024, eps=1e-05)
          )
        )
      )
      (res5): Sequential(
        (0): BottleneckBlock(
          (shortcut): Conv2d(
            1024, 2048, kernel_size=(1, 1), stride=(2, 2), bias=False
            (norm): FrozenBatchNorm2d(num_features=2048, eps=1e-05)
          )
          (conv1): Conv2d(
            1024, 512, kernel_size=(1, 1), stride=(2, 2), bias=False
            (norm): FrozenBatchNorm2d(num_features=512, eps=1e-05)
          )
          (conv2): Conv2d(
            512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=512, eps=1e-05)
          )
          (conv3): Conv2d(
            512, 2048, kernel_size=(1, 1), stride=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=2048, eps=1e-05)
          )
        )
        (1): BottleneckBlock(
          (conv1): Conv2d(
            2048, 512, kernel_size=(1, 1), stride=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=512, eps=1e-05)
          )
          (conv2): Conv2d(
            512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=512, eps=1e-05)
          )
          (conv3): Conv2d(
            512, 2048, kernel_size=(1, 1), stride=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=2048, eps=1e-05)
          )
        )
        (2): BottleneckBlock(
          (conv1): Conv2d(
            2048, 512, kernel_size=(1, 1), stride=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=512, eps=1e-05)
          )
          (conv2): Conv2d(
            512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=512, eps=1e-05)
          )
          (conv3): Conv2d(
            512, 2048, kernel_size=(1, 1), stride=(1, 1), bias=False
            (norm): FrozenBatchNorm2d(num_features=2048, eps=1e-05)
          )
        )
      )
    )
  )
  (proposal_generator): RPN(
    (rpn_head): StandardRPNHead(
      (conv): Conv2d(
        256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1)
        (activation): ReLU()
      )
      (objectness_logits): Conv2d(256, 3, kernel_size=(1, 1), stride=(1, 1))
      (anchor_deltas): Conv2d(256, 12, kernel_size=(1, 1), stride=(1, 1))
    )
    (anchor_generator): DefaultAnchorGenerator(
      (cell_anchors): BufferList()
    )
  )
  (roi_heads): StandardROIHeads(
    (box_pooler): ROIPooler(
      (level_poolers): ModuleList(
        (0): ROIAlign(output_size=(7, 7), spatial_scale=0.25, sampling_ratio=0, aligned=True)
        (1): ROIAlign(output_size=(7, 7), spatial_scale=0.125, sampling_ratio=0, aligned=True)
        (2): ROIAlign(output_size=(7, 7), spatial_scale=0.0625, sampling_ratio=0, aligned=True)
        (3): ROIAlign(output_size=(7, 7), spatial_scale=0.03125, sampling_ratio=0, aligned=True)
      )
    )
    (box_head): FastRCNNConvFCHead(
      (flatten): Flatten(start_dim=1, end_dim=-1)
      (fc1): Linear(in_features=12544, out_features=1024, bias=True)
      (fc_relu1): ReLU()
      (fc2): Linear(in_features=1024, out_features=1024, bias=True)
      (fc_relu2): ReLU()
    )
    (box_predictor): FastRCNNOutputLayers(
      (cls_score): Linear(in_features=1024, out_features=8, bias=True)
      (bbox_pred): Linear(in_features=1024, out_features=28, bias=True)
    )
    (mask_pooler): ROIPooler(
      (level_poolers): ModuleList(
        (0): ROIAlign(output_size=(14, 14), spatial_scale=0.25, sampling_ratio=0, aligned=True)
        (1): ROIAlign(output_size=(14, 14), spatial_scale=0.125, sampling_ratio=0, aligned=True)
        (2): ROIAlign(output_size=(14, 14), spatial_scale=0.0625, sampling_ratio=0, aligned=True)
        (3): ROIAlign(output_size=(14, 14), spatial_scale=0.03125, sampling_ratio=0, aligned=True)
      )
    )
    (mask_head): MaskRCNNConvUpsampleHead(
      (mask_fcn1): Conv2d(
        256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1)
        (activation): ReLU()
      )
      (mask_fcn2): Conv2d(
        256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1)
        (activation): ReLU()
      )
      (mask_fcn3): Conv2d(
        256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1)
        (activation): ReLU()
      )
      (mask_fcn4): Conv2d(
        256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1)
        (activation): ReLU()
      )
      (deconv): ConvTranspose2d(256, 256, kernel_size=(2, 2), stride=(2, 2))
      (deconv_relu): ReLU()
      (predictor): Conv2d(256, 7, kernel_size=(1, 1), stride=(1, 1))
    )
  )
)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Green">[01/21 05:30:28 d2.data.datasets.coco]: </span>Loaded 118 images in COCO format from novelctrlk6_8_coco_dataset/train/annotations.json
<span class=" -Color -Color-Green">[01/21 05:30:28 d2.data.build]: </span>Removed 0 images with no usable annotations. 118 images left.
<span class=" -Color -Color-Green">[01/21 05:30:28 d2.data.dataset_mapper]: </span>[DatasetMapper] Augmentations used in training: [ResizeShortestEdge(short_edge_length=(640, 672, 704, 736, 768, 800), max_size=1333, sample_style=&#39;choice&#39;), RandomFlip()]
<span class=" -Color -Color-Green">[01/21 05:30:28 d2.data.build]: </span>Using training sampler RepeatFactorTrainingSampler
<span class=" -Color -Color-Green">[01/21 05:30:28 d2.data.common]: </span>Serializing 118 elements to byte tensors and concatenating them all ...
<span class=" -Color -Color-Green">[01/21 05:30:28 d2.data.common]: </span>Serialized dataset takes 0.31 MiB
<span class=" -Color -Color-Red">WARNING</span> <span class=" -Color -Color-Green">[01/21 05:30:28 d2.solver.build]: </span>SOLVER.STEPS contains values larger than SOLVER.MAX_ITER. These values will be ignored.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Skip loading parameter &#39;roi_heads.box_predictor.cls_score.weight&#39; to the model due to incompatible shapes: (81, 1024) in the checkpoint but (8, 1024) in the model! You might want to double check if this is expected.
Skip loading parameter &#39;roi_heads.box_predictor.cls_score.bias&#39; to the model due to incompatible shapes: (81,) in the checkpoint but (8,) in the model! You might want to double check if this is expected.
Skip loading parameter &#39;roi_heads.box_predictor.bbox_pred.weight&#39; to the model due to incompatible shapes: (320, 1024) in the checkpoint but (28, 1024) in the model! You might want to double check if this is expected.
Skip loading parameter &#39;roi_heads.box_predictor.bbox_pred.bias&#39; to the model due to incompatible shapes: (320,) in the checkpoint but (28,) in the model! You might want to double check if this is expected.
Skip loading parameter &#39;roi_heads.mask_head.predictor.weight&#39; to the model due to incompatible shapes: (80, 256, 1, 1) in the checkpoint but (7, 256, 1, 1) in the model! You might want to double check if this is expected.
Skip loading parameter &#39;roi_heads.mask_head.predictor.bias&#39; to the model due to incompatible shapes: (80,) in the checkpoint but (7,) in the model! You might want to double check if this is expected.
Some model parameters or buffers are not found in the checkpoint:
<span class=" -Color -Color-Blue">roi_heads.box_predictor.bbox_pred.{bias, weight}</span>
<span class=" -Color -Color-Blue">roi_heads.box_predictor.cls_score.{bias, weight}</span>
<span class=" -Color -Color-Blue">roi_heads.mask_head.predictor.{bias, weight}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Look at training curves in tensorboard:</span>
<span class="o">%</span><span class="k">load_ext</span> tensorboard
<span class="o">%</span><span class="k">tensorboard</span> --logdir output
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
<iframe id="tensorboard-frame-fca08d0d9041cf7c" width="100%" height="800" frameborder="0">
</iframe>
<script>
  (function() {
    const frame = document.getElementById("tensorboard-frame-fca08d0d9041cf7c");
    const url = new URL("/", window.location);
    const port = 6006;
    if (port) {
      url.port = port;
    }
    frame.src = url;
  })();
</script>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Green">[01/21 05:30:32 d2.engine.train_loop]: </span>Starting training from iteration 0
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/jeremy/anaconda3/envs/annolid/lib/python3.7/site-packages/detectron2/structures/image_list.py:88: UserWarning: __floordiv__ is deprecated, and its behavior will change in a future version of pytorch. It currently rounds toward 0 (like the &#39;trunc&#39; function NOT &#39;floor&#39;). This results in incorrect rounding for negative values. To keep the current behavior, use torch.div(a, b, rounding_mode=&#39;trunc&#39;), or for actual floor division, use torch.div(a, b, rounding_mode=&#39;floor&#39;).
  max_size = (max_size + (stride - 1)) // stride * stride
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Green">[01/21 05:45:21 d2.utils.events]: </span> eta: 1 day, 11:17:38  iter: 19  total_loss: 5.468  loss_cls: 2.148  loss_box_reg: 0.5272  loss_mask: 0.6881  loss_rpn_cls: 1.72  loss_rpn_loc: 0.3729  time: 43.2125  data_time: 0.9429  lr: 4.9952e-05  
<span class=" -Color -Color-Green">[01/21 06:00:07 d2.utils.events]: </span> eta: 1 day, 11:08:08  iter: 39  total_loss: 3.097  loss_cls: 1.367  loss_box_reg: 0.7502  loss_mask: 0.6692  loss_rpn_cls: 0.0581  loss_rpn_loc: 0.2386  time: 43.7766  data_time: 0.1620  lr: 9.9902e-05  
<span class=" -Color -Color-Green">[01/21 06:15:11 d2.utils.events]: </span> eta: 1 day, 11:23:44  iter: 59  total_loss: 2.656  loss_cls: 0.9361  loss_box_reg: 0.8174  loss_mask: 0.6501  loss_rpn_cls: 0.04557  loss_rpn_loc: 0.2009  time: 44.2544  data_time: 0.3378  lr: 0.00014985  
<span class=" -Color -Color-Green">[01/21 06:30:06 d2.utils.events]: </span> eta: 1 day, 11:36:27  iter: 79  total_loss: 2.546  loss_cls: 0.8501  loss_box_reg: 0.8529  loss_mask: 0.6259  loss_rpn_cls: 0.03656  loss_rpn_loc: 0.171  time: 44.3795  data_time: 0.2600  lr: 0.0001998  
<span class=" -Color -Color-Green">[01/21 06:45:25 d2.utils.events]: </span> eta: 1 day, 11:49:31  iter: 99  total_loss: 2.398  loss_cls: 0.7593  loss_box_reg: 0.8424  loss_mask: 0.5998  loss_rpn_cls: 0.02868  loss_rpn_loc: 0.1571  time: 44.7053  data_time: 0.2938  lr: 0.00024975  
<span class=" -Color -Color-Green">[01/21 07:00:40 d2.utils.events]: </span> eta: 1 day, 12:00:27  iter: 119  total_loss: 2.246  loss_cls: 0.6708  loss_box_reg: 0.8458  loss_mask: 0.5625  loss_rpn_cls: 0.02621  loss_rpn_loc: 0.1413  time: 44.8800  data_time: 0.2338  lr: 0.0002997  
<span class=" -Color -Color-Green">[01/21 07:15:43 d2.utils.events]: </span> eta: 1 day, 11:45:27  iter: 139  total_loss: 2.088  loss_cls: 0.5662  loss_box_reg: 0.8213  loss_mask: 0.516  loss_rpn_cls: 0.0241  loss_rpn_loc: 0.1524  time: 44.9145  data_time: 0.3756  lr: 0.00034965  
<span class=" -Color -Color-Green">[01/21 07:30:58 d2.utils.events]: </span> eta: 1 day, 11:35:28  iter: 159  total_loss: 1.935  loss_cls: 0.4962  loss_box_reg: 0.8112  loss_mask: 0.4783  loss_rpn_cls: 0.01789  loss_rpn_loc: 0.1299  time: 45.0222  data_time: 0.2637  lr: 0.0003996  
<span class=" -Color -Color-Green">[01/21 07:45:27 d2.utils.events]: </span> eta: 1 day, 10:58:47  iter: 179  total_loss: 1.76  loss_cls: 0.4156  loss_box_reg: 0.7409  loss_mask: 0.4555  loss_rpn_cls: 0.01664  loss_rpn_loc: 0.1159  time: 44.8434  data_time: 0.3959  lr: 0.00044955  
<span class=" -Color -Color-Green">[01/21 08:00:15 d2.utils.events]: </span> eta: 1 day, 10:45:20  iter: 199  total_loss: 1.601  loss_cls: 0.3544  loss_box_reg: 0.6466  loss_mask: 0.4189  loss_rpn_cls: 0.01428  loss_rpn_loc: 0.155  time: 44.7952  data_time: 0.1965  lr: 0.0004995  
<span class=" -Color -Color-Green">[01/21 08:19:34 d2.utils.events]: </span> eta: 1 day, 10:53:54  iter: 219  total_loss: 1.503  loss_cls: 0.332  loss_box_reg: 0.627  loss_mask: 0.412  loss_rpn_cls: 0.01383  loss_rpn_loc: 0.1079  time: 46.0042  data_time: 0.2561  lr: 0.00054945  
<span class=" -Color -Color-Green">[01/21 08:37:55 d2.utils.events]: </span> eta: 1 day, 10:57:54  iter: 239  total_loss: 1.451  loss_cls: 0.3034  loss_box_reg: 0.6088  loss_mask: 0.3939  loss_rpn_cls: 0.01198  loss_rpn_loc: 0.1344  time: 46.7601  data_time: 1.9454  lr: 0.0005994  
<span class=" -Color -Color-Green">[01/21 08:55:18 d2.utils.events]: </span> eta: 1 day, 11:08:11  iter: 259  total_loss: 1.427  loss_cls: 0.2782  loss_box_reg: 0.5884  loss_mask: 0.3941  loss_rpn_cls: 0.01654  loss_rpn_loc: 0.1403  time: 47.1773  data_time: 0.6930  lr: 0.00064935  
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="inference-evaluation-using-the-trained-model">
<h2>Inference &amp; evaluation using the trained model<a class="headerlink" href="#inference-evaluation-using-the-trained-model" title="Permalink to this headline">¶</a></h2>
<p>Now, let’s run inference with the trained model on the validation dataset. First, let’s create a predictor using the model we just trained:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Inference should use the config with parameters that are used in training</span>
<span class="c1"># cfg now already contains everything we&#39;ve set previously. </span>
<span class="c1"># We simply update the weights with the newly trained ones to perform inference:</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">MODEL</span><span class="o">.</span><span class="n">WEIGHTS</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">OUTPUT_DIR</span><span class="p">,</span> <span class="s2">&quot;model_final.pth&quot;</span><span class="p">)</span>  <span class="c1"># path to the model we just trained</span>
<span class="c1"># set a custom testing threshold</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">MODEL</span><span class="o">.</span><span class="n">ROI_HEADS</span><span class="o">.</span><span class="n">SCORE_THRESH_TEST</span> <span class="o">=</span> <span class="mf">0.15</span>   <span class="c1">#@param {type: &quot;slider&quot;, min:0.0, max:1.0, step: 0.01}</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">DefaultPredictor</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Then, we randomly select several samples to visualize the prediction results.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">detectron2.utils.visualizer</span> <span class="kn">import</span> <span class="n">ColorMode</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset_dicts</span> <span class="o">=</span> <span class="n">get_detection_dataset_dicts</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DATASET_NAME</span><span class="si">}</span><span class="s2">_valid&quot;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">dataset_dicts</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>    
    <span class="n">im</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;file_name&quot;</span><span class="p">])</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">predictor</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>  <span class="c1"># format is documented at https://detectron2.readthedocs.io/tutorials/models.html#model-output-format</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">Visualizer</span><span class="p">(</span><span class="n">im</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                   <span class="n">metadata</span><span class="o">=</span><span class="n">_dataset_metadata</span><span class="p">,</span> 
                   <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
                   <span class="n">instance_mode</span><span class="o">=</span><span class="n">ColorMode</span><span class="o">.</span><span class="n">SEGMENTATION</span>   <span class="c1"># remove the colors of unsegmented pixels. This option is only available for segmentation models</span>
    <span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">draw_instance_predictions</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;instances&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">IN_COLAB</span><span class="p">:</span>
        <span class="n">cv2_imshow</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">get_image</span><span class="p">()[:,</span> <span class="p">:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">get_image</span><span class="p">()[:,</span> <span class="p">:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        
</pre></div>
</div>
</div>
</div>
<p>A more robust way to evaluate the model is to use a metric called Average Precision (AP) already implemented in the detectron2 package. If you want more precision on what the AP is, you can take a look <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.metrics.average_precision_score.html#sklearn.metrics.average_precision_score">here</a> and <a class="reference external" href="https://en.wikipedia.org/w/index.php?title=Information_retrieval&amp;oldid=793358396#Average_precision">here</a>.</p>
<div class="section" id="todo-expand-on-how-to-interpret-ap">
<h3>#TODO: expand on  how to interpret AP<a class="headerlink" href="#todo-expand-on-how-to-interpret-ap" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">detectron2.evaluation</span> <span class="kn">import</span> <span class="n">COCOEvaluator</span><span class="p">,</span> <span class="n">inference_on_dataset</span>
<span class="kn">from</span> <span class="nn">detectron2.data</span> <span class="kn">import</span> <span class="n">build_detection_test_loader</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">IN_COLAB</span><span class="p">:</span>
    <span class="n">evaluator</span> <span class="o">=</span> <span class="n">COCOEvaluator</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DATASET_NAME</span><span class="si">}</span><span class="s2">_valid&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="s2">&quot;/content/eval_output/&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">evaluator</span> <span class="o">=</span> <span class="n">COCOEvaluator</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DATASET_NAME</span><span class="si">}</span><span class="s2">_valid&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="s2">&quot;eval_output/&quot;</span><span class="p">)</span>

<span class="n">val_loader</span> <span class="o">=</span> <span class="n">build_detection_test_loader</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DATASET_NAME</span><span class="si">}</span><span class="s2">_valid&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">inference_on_dataset</span><span class="p">(</span><span class="n">predictor</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">evaluator</span><span class="p">))</span>
<span class="c1"># another equivalent way to evaluate the model is to use `trainer.test`</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="let-s-test-our-newly-trained-mode-on-a-new-video">
<h1>Let’s test our newly trained mode on a new video<a class="headerlink" href="#let-s-test-our-newly-trained-mode-on-a-new-video" title="Permalink to this headline">¶</a></h1>
<div class="section" id="we-download-a-video-from-a-url">
<h2>We download a video from a URL<a class="headerlink" href="#we-download-a-video-from-a-url" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#e.g.</span>
<span class="c1">#!wget https://hosting-website.com/your-video.mp4</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="please-change-the-video-input-to-the-path-of-your-inference-video">
<h3>Please change the VIDEO_INPUT to the path of your inference video<a class="headerlink" href="#please-change-the-video-input-to-the-path-of-your-inference-video" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">VIDEO_INPUT</span><span class="o">=</span><span class="s2">&quot;/content/video60.mkv&quot;</span>
<span class="n">OUTPUT_DIR</span> <span class="o">=</span> <span class="s2">&quot;/content/eval_output&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">VIDEO_INPUT</span> <span class="o">=</span> <span class="s1">&#39;../../sample_dataset/sample_video.mp4&#39;</span>
<span class="n">OUTPUT_DIR</span> <span class="o">=</span> <span class="s2">&quot;../../sample_dataset/&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">cv2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">video</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">VIDEO_INPUT</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_WIDTH</span><span class="p">))</span>
<span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_HEIGHT</span><span class="p">))</span>
<span class="n">frames_per_second</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FPS</span><span class="p">)</span>
<span class="n">num_frames</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_COUNT</span><span class="p">))</span>
<span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">VIDEO_INPUT</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span> 
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">OUTPUT_DIR</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_frame_from_video</span><span class="p">(</span><span class="n">video</span><span class="p">):</span>
  <span class="n">attempt</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_frames</span><span class="p">):</span>
      <span class="n">success</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
          <span class="k">yield</span> <span class="n">frame</span>
      <span class="k">else</span><span class="p">:</span>
          <span class="n">attempt</span> <span class="o">+=</span> <span class="mi">1</span>
          <span class="k">if</span> <span class="n">attempt</span> <span class="o">&gt;=</span> <span class="mi">2000</span><span class="p">:</span>
              <span class="k">break</span>
          <span class="k">else</span><span class="p">:</span>
              <span class="n">video</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_POS_FRAMES</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
              <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot read this frame:&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
              <span class="k">continue</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pycocotools.mask</span> <span class="k">as</span> <span class="nn">mask_util</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">class_names</span> <span class="o">=</span> <span class="n">_dataset_metadata</span><span class="o">.</span><span class="n">thing_classes</span>
<span class="nb">print</span><span class="p">(</span><span class="n">class_names</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">frame_number</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">tracking_results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">VIS</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">_frame_from_video</span><span class="p">(</span><span class="n">video</span><span class="p">):</span> 
    <span class="n">im</span> <span class="o">=</span> <span class="n">frame</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">predictor</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{}</span>  
    <span class="n">instances</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;instances&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
    <span class="n">num_instance</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_instance</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;frame_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">frame_number</span>
        <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;x1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;y1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;x2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;y2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;instance_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;class_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;segmentation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">tracking_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_dict</span><span class="p">)</span>
        <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">boxes</span> <span class="o">=</span> <span class="n">instances</span><span class="o">.</span><span class="n">pred_boxes</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">boxes</span> <span class="o">=</span> <span class="n">boxes</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">instances</span><span class="o">.</span><span class="n">scores</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="n">instances</span><span class="o">.</span><span class="n">pred_classes</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">has_mask</span> <span class="o">=</span> <span class="n">instances</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="s2">&quot;pred_masks&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">has_mask</span><span class="p">:</span>
            <span class="n">rles</span> <span class="o">=</span><span class="p">[</span>
                   <span class="n">mask_util</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">[:,:,</span><span class="kc">None</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="s2">&quot;F&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;uint8&quot;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                   <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">instances</span><span class="o">.</span><span class="n">pred_masks</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">rle</span> <span class="ow">in</span> <span class="n">rles</span><span class="p">:</span>
              <span class="n">rle</span><span class="p">[</span><span class="s2">&quot;counts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rle</span><span class="p">[</span><span class="s2">&quot;counts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">rles</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">boxes</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_instance</span><span class="p">):</span>
            <span class="n">box</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;frame_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">frame_number</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;x1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;y1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;x2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;y2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;instance_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">class_names</span><span class="p">[</span><span class="n">classes</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;class_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;segmentation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rles</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">frame_number</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
              <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Frame number </span><span class="si">{</span><span class="n">frame_number</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">out_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">tracking_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_dict</span><span class="p">)</span>
            <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{}</span>
        
    <span class="c1"># format is documented at https://detectron2.readthedocs.io/tutorials/models.html#model-output-format</span>
    <span class="k">if</span> <span class="n">VIS</span><span class="p">:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">Visualizer</span><span class="p">(</span><span class="n">im</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">metadata</span><span class="o">=</span><span class="n">_dataset_metadata</span><span class="p">,</span> 
                    <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
                    <span class="n">instance_mode</span><span class="o">=</span><span class="n">ColorMode</span><span class="o">.</span><span class="n">IMAGE_BW</span>   <span class="c1"># remove the colors of unsegmented pixels. This option is only available for segmentation models</span>
         <span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">draw_instance_predictions</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;instances&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">))</span>
        <span class="n">out_image</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">get_image</span><span class="p">()[:,</span> <span class="p">:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">frame_number</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">IN_COLAB</span><span class="p">:</span>
                <span class="n">cv2_imshow</span><span class="p">(</span><span class="n">out_image</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">out_image</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="c1">#Trun off the visulization to save time after the first frame</span>
            <span class="n">VIS</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">frame_number</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing frame number </span><span class="si">{</span><span class="n">frame_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">video</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="all-the-tracking-results-will-be-saved-to-this-pandas-dataframe">
<h2>All the tracking results will be saved to this Pandas dataframe.<a class="headerlink" href="#all-the-tracking-results-will-be-saved-to-this-pandas-dataframe" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">tracking_results</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="calculate-the-bbox-center-point-x-y-locations">
<h2>Calculate the bbox center point x, y locations<a class="headerlink" href="#calculate-the-bbox-center-point-x-y-locations" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cx</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">x1</span> <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">x2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
<span class="n">cy</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">y1</span> <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">y2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;cx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;cy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cy</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="only-save-the-top-1-prediction-for-each-frame-for-each-class">
<h2>Only save the top 1 prediction for each frame for each class<a class="headerlink" href="#only-save-the-top-1-prediction-for-each-frame-for-each-class" title="Permalink to this headline">¶</a></h2>
<p>Note: You can change the number to save top n predictions for each frame and an instance name. head(2), head(5), or head(n)
To save all the predictions, please use <code class="docutils literal notranslate"><span class="pre">df.to_csv('my_tracking_results.csv')</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_top</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;frame_number&#39;</span><span class="p">,</span><span class="s1">&#39;instance_name&#39;</span><span class="p">],</span><span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_top</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="visualize-the-center-points-with-plotly-scatter-plot">
<h2>Visualize the center points with plotly scatter plot<a class="headerlink" href="#visualize-the-center-points-with-plotly-scatter-plot" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_vis</span> <span class="o">=</span> <span class="n">df_top</span><span class="p">[</span><span class="n">df_top</span><span class="o">.</span><span class="n">instance_name</span> <span class="o">!=</span> <span class="s1">&#39;Text&#39;</span><span class="p">][[</span><span class="s1">&#39;frame_number&#39;</span><span class="p">,</span><span class="s1">&#39;cx&#39;</span><span class="p">,</span><span class="s1">&#39;cy&#39;</span><span class="p">,</span><span class="s1">&#39;instance_name&#39;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>
<span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="nn">go</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df_vis</span><span class="p">,</span> 
                 <span class="n">x</span><span class="o">=</span><span class="s2">&quot;cx&quot;</span><span class="p">,</span>
                 <span class="n">y</span><span class="o">=</span><span class="s2">&quot;cy&quot;</span><span class="p">,</span> 
                 <span class="n">color</span><span class="o">=</span><span class="s2">&quot;instance_name&quot;</span><span class="p">,</span>
                 <span class="n">hover_data</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;frame_number&#39;</span><span class="p">,</span><span class="s1">&#39;cx&#39;</span><span class="p">,</span><span class="s1">&#39;cy&#39;</span><span class="p">])</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span>  <span class="n">Path</span>
<span class="n">tracking_results_csv</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">VIDEO_INPUT</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">SOLVER</span><span class="o">.</span><span class="n">MAX_ITER</span><span class="si">}</span><span class="s2">_iters_mask_rcnn_tracking_results_with_segmenation.csv&quot;</span>
<span class="n">df_top</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">tracking_results_csv</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="download-the-tracking-result-csv-file-to-your-local-device">
<h2>Download the tracking result CSV file to your local device<a class="headerlink" href="#download-the-tracking-result-csv-file-to-your-local-device" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">IN_COLAB</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">google.colab</span> <span class="kn">import</span> <span class="n">files</span>
    <span class="n">files</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tracking_results_csv</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="the-following-sections-are-optional">
<h1>The following sections are optional.<a class="headerlink" href="#the-following-sections-are-optional" title="Permalink to this headline">¶</a></h1>
<div class="section" id="caculate-the-distance-of-a-pair-of-instances-in-a-given-frame">
<h2>Caculate the distance of a pair of instances in a given frame<a class="headerlink" href="#caculate-the-distance-of-a-pair-of-instances-in-a-given-frame" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">paired_distance</span><span class="p">(</span><span class="n">frame_number</span><span class="p">,</span>
                    <span class="n">this_instance</span><span class="o">=</span><span class="s1">&#39;frog_m_2&#39;</span><span class="p">,</span>
                    <span class="n">other_instance</span><span class="o">=</span><span class="s1">&#39;frog_f_2&#39;</span><span class="p">):</span>
    <span class="n">df_dis</span> <span class="o">=</span> <span class="n">df_top</span><span class="p">[</span><span class="n">df_top</span><span class="p">[</span><span class="s2">&quot;frame_number&quot;</span><span class="p">]</span><span class="o">==</span><span class="n">frame_number</span><span class="p">][[</span><span class="s1">&#39;cx&#39;</span><span class="p">,</span><span class="s1">&#39;cy&#39;</span><span class="p">,</span><span class="s1">&#39;instance_name&#39;</span><span class="p">]]</span>
    <span class="n">df_this</span> <span class="o">=</span> <span class="n">df_dis</span><span class="p">[</span><span class="n">df_dis</span><span class="o">.</span><span class="n">instance_name</span> <span class="o">==</span> <span class="n">this_instance</span><span class="p">]</span>
    <span class="n">df_other</span> <span class="o">=</span> <span class="n">df_dis</span><span class="p">[</span><span class="n">df_dis</span><span class="o">.</span><span class="n">instance_name</span> <span class="o">==</span> <span class="n">other_instance</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">df_this</span><span class="p">[[</span><span class="s1">&#39;cx&#39;</span><span class="p">,</span><span class="s1">&#39;cy&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">-</span><span class="n">df_other</span><span class="p">[[</span><span class="s1">&#39;cx&#39;</span><span class="p">,</span><span class="s1">&#39;cy&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="n">dist</span> <span class="o">=</span> <span class="kc">None</span>


    <span class="k">return</span> <span class="n">dist</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="calculate-the-distance-of-the-instance-from-the-current-and-previous-frame">
<h2>Calculate the distance of the instance from the current and previous frame<a class="headerlink" href="#calculate-the-distance-of-the-instance-from-the-current-and-previous-frame" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">instance_distance_between_frame</span><span class="p">(</span><span class="n">frame_number</span><span class="p">,</span>
                                    <span class="n">instance_name</span><span class="o">=</span><span class="s1">&#39;frog_m_1&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">frame_number</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
      <span class="k">return</span> <span class="mi">0</span>
    <span class="n">previous_frame_number</span> <span class="o">=</span> <span class="n">frame_number</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">df_dis</span> <span class="o">=</span> <span class="n">df_top</span><span class="p">[</span><span class="n">df_top</span><span class="p">[</span><span class="s2">&quot;frame_number&quot;</span><span class="p">]</span><span class="o">==</span><span class="n">frame_number</span><span class="p">][[</span><span class="s1">&#39;cx&#39;</span><span class="p">,</span><span class="s1">&#39;cy&#39;</span><span class="p">,</span><span class="s1">&#39;instance_name&#39;</span><span class="p">]]</span>
    <span class="n">df_dis_prev</span> <span class="o">=</span> <span class="n">df_top</span><span class="p">[</span><span class="n">df_top</span><span class="p">[</span><span class="s2">&quot;frame_number&quot;</span><span class="p">]</span><span class="o">==</span><span class="n">previous_frame_number</span><span class="p">][[</span><span class="s1">&#39;cx&#39;</span><span class="p">,</span><span class="s1">&#39;cy&#39;</span><span class="p">,</span><span class="s1">&#39;instance_name&#39;</span><span class="p">]]</span>
    <span class="n">df_dis</span> <span class="o">=</span> <span class="n">df_dis</span><span class="p">[</span><span class="n">df_dis</span><span class="o">.</span><span class="n">instance_name</span> <span class="o">==</span> <span class="n">instance_name</span><span class="p">]</span>
    <span class="n">df_dis_prev</span> <span class="o">=</span> <span class="n">df_dis_prev</span><span class="p">[</span><span class="n">df_dis_prev</span><span class="o">.</span><span class="n">instance_name</span> <span class="o">==</span> <span class="n">instance_name</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">df_dis</span><span class="p">[[</span><span class="s1">&#39;cx&#39;</span><span class="p">,</span><span class="s1">&#39;cy&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">-</span><span class="n">df_dis_prev</span><span class="p">[[</span><span class="s1">&#39;cx&#39;</span><span class="p">,</span><span class="s1">&#39;cy&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="n">dist</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">return</span> <span class="n">dist</span>
    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_top</span><span class="p">[</span><span class="s1">&#39;dist_from_previous_frame_frog_m_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_top</span><span class="o">.</span><span class="n">frame_number</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">instance_distance_between_frame</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="the-total-distance-traveled-for-frog-male-in-tank-1-in-pixels">
<h2>The total distance traveled for frog male in Tank 1 in pixels<a class="headerlink" href="#the-total-distance-traveled-for-frog-male-in-tank-1-in-pixels" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_top</span><span class="p">[</span><span class="s1">&#39;dist_from_previous_frame_frog_m_1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">df_top</span><span class="o">.</span><span class="n">frame_number</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">df_top</span><span class="o">.</span><span class="n">dist_from_previous_frame_frog_m_1</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span><span class="s1">&#39;frame_number&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span><span class="s1">&#39;distance from previous frame frog_m_1&#39;</span><span class="p">})</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="download-and-save-the-results-to-your-local-device">
<h2>Download and save the results to your local device<a class="headerlink" href="#download-and-save-the-results-to-your-local-device" title="Permalink to this headline">¶</a></h2>
<div class="section" id="please-change-the-desired-csv-file-name">
<h3>Please change the desired CSV file name<a class="headerlink" href="#please-change-the-desired-csv-file-name" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tracking_results_with_area_perimeter_csv</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tracking_results_csv</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span><span class="s1">&#39;_final.csv&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="n">df_top</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">tracking_results_with_area_perimeter_csv</span><span class="p">)</span>
<span class="n">files</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tracking_results_with_area_perimeter_csv</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="distance-between-frog-male-in-tank-2-and-frog-female-in-tank-2-in-pixels">
<h2>Distance between frog male in tank 2 and frog female in tank 2 in pixels<a class="headerlink" href="#distance-between-frog-male-in-tank-2-and-frog-female-in-tank-2-in-pixels" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_top</span><span class="p">[</span><span class="s1">&#39;dist_frog_m2_f2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_top</span><span class="o">.</span><span class="n">frame_number</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">paired_distance</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">df_top</span><span class="o">.</span><span class="n">frame_number</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">df_top</span><span class="o">.</span><span class="n">dist_frog_m2_f2</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span><span class="s1">&#39;frame_number&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span><span class="s1">&#39;distance between frog male in tank 2 to frog female in tank 2&#39;</span><span class="p">})</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="save-and-download-the-trained-model-weights">
<h2>Save and download the trained model weights<a class="headerlink" href="#save-and-download-the-trained-model-weights" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">final_model_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">OUTPUT_DIR</span><span class="p">,</span><span class="s1">&#39;model_final.pth&#39;</span><span class="p">)</span>
<span class="n">files</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">final_model_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "annolid-env"
        },
        kernelOptions: {
            kernelName: "annolid-env",
            path: "./tutorials"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'annolid-env'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Chen Yang, Jeremy Forest, Matthew Einhorn, Thomas Cleland<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>